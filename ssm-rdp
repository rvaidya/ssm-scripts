#!/bin/bash

instance_name=$1
remote_port=3389
local_port=54000

# generate a new user on the target instance
ssm_username="ssm_$(cat /dev/urandom | tr -dc 'a-zA-Z0-9' | fold -w 8 | head -n 1)"
ssm_group=Administrators

# password must have at least 1 number
ssm_password="$(cat /dev/urandom | tr -dc 'a-zA-Z0-9' | fold -w 10 | head -n 1)$(cat /dev/urandom | tr -dc '0-9' | fold -w 2 | head -n 1)"

# provision the user
ssm-ps $instance_name "(\$Password = ConvertTo-SecureString '$ssm_password' -AsPlainText -Force) -and (New-LocalUser '$ssm_username' -Password \$Password -FullName 'Autogenerated SSMUser' -Description 'Autogenerated ssm user')"

ssm-ps $instance_name "Add-LocalGroupMember -Group '$ssm_group' -Member '$ssm_username'"

# echo temporary credentials
echo "Use these credentials to log in:"
echo "Username: $ssm_username"
echo "Password: $ssm_password"

# save the generated credentials
cmdkey.exe /generic:"localhost" /user:"$ssm_username" /pass:"$ssm_password"
# launch the RDP client, sleep for a bit to allow time for the tunnel to establish
bash -c "sleep 5 && mstsc.exe /v:'localhost:$local_port'" &

# create the port forwarding tunnel
ssm-tunnel $instance_name $remote_port $local_port

# remove the user once we're done
ssm-ps $instance_name "Remove-LocalUser -Name '$ssm_username'"

# remove the credentials as well
cmdkey.exe /delete:"localhost"
