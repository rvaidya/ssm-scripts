#!/bin/bash

instance_name=$1
local_port=${2:-54000}
remote_port=${3:-3389}
ssm_host=${4:-localhost}

# generate a new user on the target instance
ssm_username="ssm_$(cat /dev/urandom | tr -dc 'a-zA-Z0-9' | fold -w 8 | head -n 1)"
ssm_group=Administrators

# password must have at least 1 number
ssm_password="$(cat /dev/urandom | tr -dc 'a-zA-Z0-9' | fold -w 10 | head -n 1)$(cat /dev/urandom | tr -dc '0-9' | fold -w 2 | head -n 1)"

# provision the user
ssm-ps $instance_name "(\$Password = ConvertTo-SecureString '$ssm_password' -AsPlainText -Force) -and (New-LocalUser '$ssm_username' -Password \$Password -FullName 'Autogenerated SSMUser' -Description 'Autogenerated ssm user')" > /dev/null
ssm-ps $instance_name "Add-LocalGroupMember -Group '$ssm_group' -Member '$ssm_username'" > /dev/null

# echo temporary credentials
echo "Use these credentials to log in:"
echo "Address: $ssm_host:$local_port"
echo "Username: $ssm_username"
echo "Password: $ssm_password"

# run mstsc if binaries exist, in background
(sleep 5 && ssm-mstsc "$ssm_username" "$ssm_password" $local_port $remote_port "$ssm_host") &

# create the port forwarding tunnel
ssm-tunnel $instance_name $remote_port $local_port

# remove the user once we're done
ssm-ps $instance_name "Remove-LocalUser -Name '$ssm_username'" > /dev/null
